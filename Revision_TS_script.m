%% step 1: Load full circuit 
clear
clc
cd c:/users/zactus/feederReduction/
% p='c:\users\zactus\gridIntegration\Alpine.dss';
p='c:\users\zactus\feederReduction\Alpine_106pen.dss';
tic

AllBus={'sourcebus';'0355';'03551';'03552';'03552a';'035510';'035511';'035510a';'035512';'03551001';'03551201';'035513';'03551202';'03551306';'035514';'035513a';'03551394';'03551392';'03551306a';'03551394a';'035515';'03551301';'03551305';'03551301a';'03551302';'03551303';'03551304';'03551393';'03551307';'03551308';'03551314';'03551308a';'03551315';'03551367';'03551309';'03551313';'03551310';'03551311';'03551312';'03551316';'03551367a';'03551317';'03551318';'03551319';'03551365';'03551320';'03551366';'03551321';'03551322';'03551323';'03551324';'03551326';'03551348';'03551325';'03551327';'03551349';'03551333';'03551328';'03551334';'03551335';'03551346';'03551328a';'03551329';'03551330';'03551331';'03551332';'03551336';'03551345';'03551347';'03551337';'03551339';'03551342';'03551337a';'03551340';'03551343';'03551338';'03551341';'03551344';'03551350';'03551356';'03551350a';'03551357';'03551351';'03551352';'03551353';'03551354';'03551355';'03551358';'03551359';'03551360';'03551361';'03551362';'03551364';'03551363';'03551368';'03551369';'03551370';'03551371';'03551390';'03551391';'03551372';'03551389';'03551373';'03551387';'03551388';'03551374';'03551375';'03551378';'03551376';'03551377';'03551379';'03551380';'03551385';'03551381';'03551385a';'03551382';'03551383';'03551383a';'03551384';'03551386';'03551395';'035516';'035517';'035516a';'035518';'035517a';'03551601';'03551602';'03551603';'03551604';'03551605';'03551801';'035519';'03551802';'03551701';'03551702';'03551703';'03551704';'03551708';'03551705';'03551709';'03551715';'03551716';'03551706';'03551707';'03551709a';'03551710';'03551711';'03551712';'03551714';'03551713';'03551803';'035520';'035521';'035520a';'035522';'03552001';'035523';'035524';'035524a';'035525';'03552501';'035526';'03552502';'03552601';'035527';'03552502a';'03552503';'03552510';'03552503a';'03552513';'03552510a';'03552504';'03552509';'03552505';'03552507';'03552506';'03552508';'03552514';'03552511';'03552511a';'03552512';'03552545';'03552514a';'03552546';'03552515';'03552518';'03552532';'03552516';'03552517';'03552522';'03552519';'03552533';'03552537';'03552541';'03552520';'03552524';'03552523';'03552521';'03552525';'03552526';'03552530';'03552527';'03552531';'03552528';'03552529';'03552534';'03552537a';'03552541a';'03552534a';'03552535';'03552536';'03552538';'03552540';'03552539';'03552542';'03552543';'03552544';'03552547';'03552553';'03552547a';'03552571';'03552553a';'03552548';'03552549';'03552550';'03552551';'03552552';'03552573';'03552571a';'03552554';'03552555';'03552561';'03552569';'03552555a';'03552562';'03552570';'03552556';'03552557';'03552558';'03552559';'03552560';'03552563';'03552564';'03552565';'03552566';'03552567';'03552568';'03552574';'03552572';'03552575';'03552576';'03552577';'03552631';'03552578';'03552631a';'03552579';'03552578a';'03552579a';'03552629';'03552630';'03552580';'03552580a';'03552581';'03552582';'03552583';'03552584';'03552584a';'03552585';'03552586';'03552598';'03552623';'03552622';'03552587';'03552599';'03552624';'03552588';'03552589';'03552590';'03552593';'03552594';'03552595';'03552591';'03552596';'03552597';'03552592';'03552600';'03552603';'03552604';'03552600a';'03552605';'03552607';'03552608';'035527a';'03552602';'03552605a';'03552609';'03552619';'03552606';'03552610';'03552615';'03552617';'03552620';'03552612';'03552611';'03552616';'03552618';'03552613';'03552614';'03552621';'03552625';'03552626';'03552628';'03552627';'03552632';'03552639';'03552633';'03552641';'03552639a';'03552634';'03552635';'03552638';'03552635a';'03552636';'03552637';'03552641a';'03552640';'03552642';'03552643';'03552644';'03552644a';'03552645';'03552646';'035528';'035529';'035530';'035529a';'035531';'03552901';'03552902';'0355201';'03553';'0355301';'03554';'0355302';'03555';'035532';'03553207';'035533';'035532a';'03553207a';'03553346';'035534';'035533a';'03553201';'03553202';'03553203';'03553203a';'03553204';'03553205';'03553206';'03553208';'03553209';'03553210';'035535';'03553301';'03553302';'03553303';'03553304';'03553307';'03553305';'03553309';'03553307a';'03553306';'03553310';'03553312';'03553308';'03553311';'03553313';'03553314';'03553315';'03553323';'03553336';'03553316';'03553324';'03553325';'03553337';'03553317';'03553318';'03553319';'03553320';'03553321';'03553322';'03553326';'03553327';'03553326a';'03553328';'03553334';'03553335';'03553329';'03553330';'03553331';'03553332';'03553333';'03553339';'03553337a';'03553340';'03553338';'03553341';'03553342';'03553343';'03553344';'03553345';'035536';'035537';'035536a';'035538';'03553602';'03553603';'03553604';'03553605';'03553606';'03553608';'03553607';'03553609';'03553601';'035539';'035538a';'035540';'03553801';'03553802';'03553803';'03553804';'03553805';'03553809';'03553806';'03553807';'03553808';'035541';'035540a';'03556';'03555a';'035542';'03554002';'03554003';'03554004';'03554005';'03554006';'03554007';'03554008';'03554009';'03554001';'035543';'035542a';'03554301';'035543a';'03554201';'03554202';'03554301a';'03554302';'03554303';'03554304';'03554305';'035544';'03554401';'035545';'03554401a';'035546';'03554402';'03554403';'03554405';'03554406';'03554404';'03554410';'03554414';'03554413';'03554407';'03554408';'03554410a';'03554414a';'03554409';'03554411';'03554411a';'03554412';'03554415';'03554416';'03554417';'03554418';'03554419';'035546a';'035547';'035548';'035549';'035548a';'035550';'035549a';'03554801';'03554802';'03554803';'03554804';'03554805';'03554806';'03554806a';'03554807';'03554808';'03554809';'03554810';'035551';'03554901';'03554902';'03554903';'03554913';'03554904';'03554907';'03554905';'03554908';'03554914';'03554906';'03554909';'03554910';'03554911';'03554912';'03554915';'03554916';'03554917';'03557';'035552';'0355501';'0355502';'0355503';'0355504';'0355505';'0355506';'035553';'035554';'035555';'035556';'03555501';'03555501a';'03555601';'035557';'03555502';'03555503';'03555504';'03555601a';'035558';'035557a';'03555602';'03555603';'03555604';'035559';'03555701';'03555702';'03555703';'03555704';'035560';'03558';'03559';'0355801';'0355901';'0355949';'0355902';'0355949a';'0355903';'0355904';'0355905';'0355906';'0355906a';'0355907';'0355908';'0355944';'0355920';'0355908a';'0355945';'0355946';'0355921';'0355923';'0355909';'0355910';'0355911';'0355912';'0355919';'0355913';'0355914';'0355915';'0355916';'0355918';'0355917';'0355921a';'0355924';'0355922';'0355930';'0355924a';'0355933';'0355930a';'0355925';'0355926';'0355928';'0355927';'0355929';'0355938';'0355939';'0355933a';'0355931';'0355932';'0355943';'0355939a';'0355934';'0355935';'0355936';'0355937';'0355940';'0355941';'0355942';'03551314a';'0355947';'0355948';'0355950';'0355951';'0355952';'0355953'};

sims=[1:5:620];
vDiffMat=zeros(length(AllBus),length(sims),2880/4);

% for XXX=621
for XXX=1:5:620
%% Step 2: Reduce
 
criticalBuses=(round((length(AllBus)-1)*rand(XXX,1))+1);
while length(unique(criticalBuses))~=XXX
	criticalBuses=[unique(criticalBuses); round((length(AllBus)-1)*(rand(XXX-length(unique(criticalBuses)),1)))+1];
end
criticalBuses=AllBus(criticalBuses);
	% criticalBuses={'0355';'035510';'035510a';'035512';'03551201';'035513';'03551301';'03551301a';'03551304';'03551305';'03551306';'03551306a';'03551308';'03551308a';'03551311';'03551314';'03551318';'03551321';'03551322';'03551323';'03551324';'03551325';'03551327';'03551328';'03551328a';'03551333';'03551336';'03551337';'03551340';'03551341';'03551343';'03551346';'03551348';'03551350';'03551351';'03551353';'03551354';'03551355';'03551356';'03551357';'03551359';'03551361';'03551363';'03551365';'03551367';'03551368';'03551370';'03551371';'03551372';'03551374';'03551375';'03551379';'03551381';'03551382';'03551383';'03551383a';'03551385a';'03551387';'03551388';'03551389';'03551390';'03551393';'03551394a';'035515';'035516';'03551604';'035516a';'035517';'03551703';'03551704';'03551705';'03551706';'03551707';'03551708';'03551709';'03551710';'03551711';'03551713';'03551714';'03551715';'03551716';'035518';'03551803';'03552';'035520';'03552001';'035524';'035525';'03552501';'03552502';'03552503';'03552504';'03552508';'03552509';'03552510';'03552510a';'03552514';'03552515';'03552518';'03552521';'03552522';'03552523';'03552532';'03552534a';'03552536';'03552537';'03552537a';'03552541a';'03552544';'03552546';'03552547';'03552553';'03552555';'03552556';'03552562';'03552563';'03552564';'03552566';'03552570';'03552571';'03552571a';'03552572';'03552573';'03552574';'03552575';'03552576';'03552577';'03552578';'03552580';'03552581';'03552584a';'03552585';'03552587';'03552588';'03552589';'03552593';'03552594';'03552597';'03552598';'03552599';'035526';'03552601';'03552604';'03552606';'03552607';'03552608';'03552609';'03552610';'03552611';'03552612';'03552617';'03552618';'03552620';'03552621';'03552622';'03552625';'03552629';'03552631';'03552631a';'03552632';'03552636';'03552639';'03552639a';'03552641';'03552643';'03552644';'03552644a';'035527a';'035529';'03552902';'03553';'035532';'03553203a';'03553204';'03553205';'03553210';'035533';'03553303';'03553306';'03553307';'03553309';'03553310';'03553313';'03553314';'03553316';'03553317';'03553318';'03553322';'03553329';'03553331';'03553332';'03553336';'03553337';'03553337a';'03553338';'03553340';'035533a';'035534';'035535';'035536';'03553606';'03553607';'035538';'03553803';'03553805';'035538a';'035539';'035540';'03554002';'03554006';'03554007';'035541';'035542';'035542a';'035543';'03554301';'03554304';'03554305';'035544';'03554401';'03554401a';'03554402';'03554403';'03554405';'03554406';'03554409';'03554411';'03554412';'03554413';'03554415';'035546';'035548';'03554801';'03554802';'03554804';'03554807';'03554809';'035548a';'035549';'03554901';'03554902';'03554903';'03554904';'03554908';'03554912';'03554913';'03554916';'03555';'035550';'0355503';'035551';'035552';'035553';'035555';'03555504';'035556';'03555601';'03555604';'035557';'03555702';'035559';'03555a';'03556';'03558';'0355801';'03559';'0355902';'0355904';'0355905';'0355906';'0355907';'0355908';'0355908a';'0355910';'0355911';'0355912';'0355913';'0355915';'0355918';'0355923';'0355924';'0355925';'0355926';'0355927';'0355928';'0355930';'0355930a';'0355933';'0355933a';'0355934';'0355942';'0355949';'0355949a';'0355951';'sourcebus'};
cd c:/users/zactus/FeederReduction/
[circuit, circuit_orig, powerFlowFull, powerFlowReduced, pathToFile] = reducingFeeders_Final_SI(p,criticalBuses,[],1);

load('circuitMap.mat')

%% Step 3: Load Sensitivites
load('Sensitivy_file_Alpine_106pen.mat')

%% Step 4: get loadshapes and solve full circuit
load('c:/users/Zactus/feederReduction/AlpineConf.mat');

cd c:/users/zactus/gridIntegration
def_addpath
cd c:/users/zactus/feederReduction/
c=circuit_orig;
dt=30;
%test PTDF for timeload('c:/users/Zactus/feederReduction/AlpineConf.mat');
global conf
timeStart='2014-11-21';
timeEnd='2014-11-21';

timeDay=cellstr(datestr(datenum(timeStart):1:datenum(timeEnd)));
conf.timeStart=timeStart;
conf.timeEnd=timeEnd;
conf.timeDay=timeDay;
fName='Alpine';
deploySite=conf.deployment;
circuit_orig.invcontrol(1).DeltaQ_factor=0.1;
% loop through days of simulation
for tId = 1:length(timeDay)
	tic
	tDay = timeDay{tId}; indent = '      ';
	fprintf('%sDay: %s\n',indent,tDay);
	
	% all time steps for simulation
	dt = 30; % in seconds
	t = datenum(tDay) : dt/24/3600 : (datenum(tDay) + 1 - dt/24/3600); % starting from midnight and end before midnight next day
	
	% load forecast GI profiles (only load the wanted profiles)
	fc = loadForecast( datestr(tDay,'yyyymmdd'), fName, conf.fcProfileId);
	if isempty(fc)
		fprintf('\n\nDay does not exist in forecast!\n\n')
		continue
	else
		% fill in the holes in data with appropriate methods when needed. Look into the fillForecastProfile for more details.
		cd c:/users/zactus/gridIntegration
		[fc,emptyProfId] = fillForecastProfile(fc,char(deploySite),fName,tDay);
		
		%map new pv systems
		for ii=1:length(Map)
			profileTmp(:,ii)=fc.profile(:,Map(ii));
		end
		fc.profile=profileTmp;
		profileTmp=[];
			
		% assign forecast profiles to pv systems
		[c_fc, fc2] = assignProfile(circuit_orig, 'pvsystem', fc, conf.fcProfileId, conf.fcTimeZone, t, conf.fcSmoothFactor );
		
		% get load profile data
		[loadProf, rawProf] = getLoadProfile(fName,conf.loadProfileId,tId);
		
		% assign load profiles to loads
		[c_fc, lp2] = assignProfile(c_fc, 'load', loadProf, conf.loadProfileId, conf.loadProfTZone, t, conf.loadProfSmooth);
		
		cd c:/users/zactus/feederReduction/
		% run simulation using OpenDSS engine
		res = dssSimulation_simple(c_fc, conf.mode, t, tDay, [],0);
% 		resControl = dssSimulation_simple_control(c_fc, conf.mode, t, tDay, [],0);

		% add info to result struct
		res.S_load=repmat([c_fc.load{:}.kw],length(t),1).*repmat(c_fc.loadshape(end).mult(1:length(t)),1,length(c_fc.load))+1i*repmat([c_fc.load{:}.kvar],length(t),1).*repmat(c_fc.loadshape(end).mult(1:length(t)),1,length(c_fc.load));
		res.S_PV=repmat([c_fc.pvsystem{:}.pmpp],length(t),1).*[c_fc.loadshape{1:end-1}.mult];
		
	toc
	end
end

%% Step 5: Update loadshape for reduced circuit
fc_pv=[c_fc.loadshape{1:end-1}.mult];
fc_pv_red=fc_pv*circuit.Map_PVo_NODEo*circuit.Map_PVr_NODEo';
fc_ld_red=repmat(c_fc.loadshape(end).mult,1,length(circuit.load));
circuit.loadshape=dssloadshape;
for ii=1:size(fc_pv_red,2)
	circuit.loadshape(ii).name=['ls_pv' num2str(ii)];
	circuit.loadshape(ii).mult=fc_pv_red(:,ii);
	circuit.loadshape(ii).sinterval=30;
	circuit.loadshape(ii).Npts=length(fc_pv_red(:,ii));
	circuit.pvsystem(ii).daily=['ls_pv' num2str(ii)];
end

for ii=1:size(fc_ld_red,2)
	circuit.loadshape(end+1).name=['ls_ld' num2str(ii)];
	circuit.loadshape(end).mult=fc_ld_red(:,ii);
	circuit.loadshape(end).sinterval=30;
	circuit.loadshape(end).Npts=length(fc_ld_red(:,ii));
	circuit.load(ii).daily=['ls_ld' num2str(ii)];
end

%% Step 6: run Powerflow
data = dssSimulation_simple(circuit, conf.mode, t, tDay, [],0);

Keep_noControl=[];
for ii=1:length(data.nodeName)
	Keep_noControl(ii)=find(ismemberi(res.nodeName,data.nodeName(ii)));
end
voltDiff_noControl=(res.Voltage(:,Keep_noControl)-data.Voltage)';

minvDifftime(:,XXX)=min(voltDiff_noControl);
maxvDifftime(:,XXX)=max(voltDiff_noControl);
meanvDifftime(:,XXX)=mean(voltDiff_noControl);
minvDifftime=minvDifftime*.1;
meanvDifftime=maxvDifftime*.1;
meanvDifftime=meanvDifftime*.1;
voltDiff_noControl_interp=voltDiff_noControl(:,1:4:end);

vDiffMat(1:size(voltDiff_noControl,1),XXX,:)=voltDiff_noControl_interp;
vDiffMat=vDiffMat*.1;
netload=sqrt(res.TotalPower(:,1).^2+res.TotalPower(:,2).^2);
netLoadMat(:,XXX)=netload(:,1:4:end);

% [ dataControl ] = dssSimulation_TS_control( circuit, conf.mode, t, V_predict,resControl.nodeName)
end

save('OutputFromTS_forPaperRevision1.mat','netLoadMat','meanvDifftime','maxvDifftime','minvDifftime','vDiffMat','-v7.3')
% %% Step 7: error analysis
% 
% 	for ii=1:length(dataControl.nodeName)
% 		Keep(ii)=find(ismemberi(resControl.nodeName,dataControl.nodeName(ii)));
% 	end
% 
% 	voltDiff=(resControl.Voltage(:,Keep)-dataControl.Voltage)';
% 	[B,I]=sort(voltDiff);
% 	[diffV, ind]=max(abs(resControl.Voltage(:,Keep)-dataControl.Voltage));
% 	
% 	
% 	save('OutputFromTS_Alpine_106pen_newData.mat')